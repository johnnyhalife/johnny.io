--- 
layout: post
title: "How-To: Write MVP using TDD"
published: true
meta: {}

tags: []

type: post
status: publish
---
<h5>Introduction</h5> In this How To I want to show how to write code using TDD and leveraging the MVP pattern.This sample uses CAB and SCSF.  <h5>The requirement</h5> Retrieve contacts and put them in a datagrid when the Load button is pressed.  <ul>   <li>The user will be able to filter by Name, Last Name or Phone Number </li>    <li>The number of contacts found cannot be greater than 10. If it is, we should display a message (&#8220;Too many contacts, please narrow your search&#8221;) </li>    <li>If no contacts were found, we should display a message (&#8220;No contacts found&#8221;).</li> </ul>  <h5>Using Mock Objects to fake the view and services</h5> In the MVP pattern, the presenter knows about the view by its interface. To have a better separation of responsabilities, we use &#8220;services&#8221; that performs some logic. The presenter will also know about the services by their interfaces.  <br />As we want to test interactions that happens in the presenter without testing the view or the services, we need to fake them.  <br />Said that, the solution includes a few Mock Objects. These are:  <ul>   <li>A Mock View </li> </ul>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">class </font>MockView : <font color="#008080">IFindContactView</font>      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</font>    <p><font color="#0000ff">public bool</font> DisplayContactsCalled;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public bool</font> ShowMessageCalled;</p>    <p><font color="#0000ff">public void</font> DisplayContacts(<font color="#008080">List</font>&lt;<font color="#008080">Contact</font>&gt; contacts)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; DisplayContactsCalled = true;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public void</font> ShowMessage(<font color="#0000ff">string </font>message)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; ShowMessageCalled = true;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }       <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p> </p>  <ul>   <li>A Mock Service </li> </ul>  <p><font face="Courier New">&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">class </font>MockService : <font color="#008080">IContactManager</font>      <br />&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public bool </font>FindContactsCalled;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public int </font>NumberOfResults = 0;</font>    <p><font color="#0000ff">public </font><font color="#008080">List</font>&lt;<font color="#008080">Contact</font>&gt; FindContacts(<font color="#0000ff">string </font>name, <font color="#0000ff">string </font>lastName, <font color="#0000ff">string </font>phoneNumber)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; FindContactsCalled = <font color="#0000ff">true</font>;      <br />&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">List</font>&lt;<font color="#008080">Contact</font>&gt; contacts = <font color="#0000ff">new </font><font color="#008080">List</font>&lt;<font color="#008080">Contact</font>&gt;();      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">for </font>(<font color="#0000ff">int </font>i = 0; i &lt; NumberOfResults; i++)      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; contacts.Add(<font color="#0000ff">new </font><font color="#008080">Contact</font>(&quot;John&quot;, &quot;Doe&quot;, &quot;43321232-23123&quot;));      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">return </font>contacts;      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; }      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</p> </p>  <p class="MsoNormal"><i>Note</i>: In the MockService I included some additional methods for testing propose for example <i><strong>NumberOfResults</strong></i>, this method will generate the desired number of results.    <br />Also the MockObjects includes flags to check the interaction as I mentioned above, these flags are like <i>SomeMethodCalled</i> that will help us when writing assertions.</p>  <h3>Excercise</h3>  <h4>Step 1: Creating the test for the Simplest Scenario</h4>  <p>The simplest scenario is when you call the Presenter.FindContacts method the FindContacts method of the service and&#160; the View.DisplayContacts method should be called.</p>  <ol>   <li>Open the <i>FindCustomerViewPresenterFixture.cs </i> </li>    <li>Add the following code (in the <i>FindCustomerViewPresenterFixture</i> class) </li> </ol>  <p><font face="Courier New"><font face="Courier New"><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<font color="#008080">TestMethod</font>]          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public void</font> ContactsDisplayedWhenApply()          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mockService.NumberOfResults = 1;          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; presenter.FindContacts(&quot;john&quot;, <font color="#0000ff">null</font>, <font color="#0000ff">null</font>);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsTrue(mockService.FindContactsCalled);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsTrue(mockView.DisplayContactsCalled);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /></font></font></font></p>  <p>3.&#160;&#160; Now build the project, it should fail.   <br />&#160;&#160;&#160; 4.&#160;&#160; Open the <i>FindContactViewPresenter.cs</i>    <br />&#160;&#160;&#160; 5.&#160;&#160; Add the following code to the <i>FindContacts </i>method</p>  <p><font face="Courier New">&#160;&#160;&#160; <font color="#0000ff">public void </font>FindContacts(<font color="#0000ff">string </font>name, <font color="#0000ff">string </font>lastName, <font color="#0000ff">string </font>phoneNumber)      <br />&#160;&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">return</font>;      <br />&#160;&#160;&#160;&#160; }</font></p>  <p>6.&#160;&#160; Build the solution, it should run successfully   <br />&#160;&#160;&#160; 7.&#160;&#160; Run the test, it will <font color="#ff0000"><b>fail</b>.</font></p>  <p>What we have here? This kind of work help us to show our intention. This <i>baby-steps</i> will generate more consistent code. So the next step will be refactoring to pass the test.</p>  <h4>Step 2: Refactoring the method to pass the test   <br /></h4>  <ol>   <li>Open the <i>FindCustomerViewPresenter.cs </i> </li>    <li>Add the following code on the <i>FindContacts </i>method       <br /></li> </ol>  <p><font face="Courier New"><font color="#0000ff"></font></font></p>  <p><font face="Courier New"><font color="#0000ff">public void </font>FindContacts(<font color="#0000ff">string </font>name, <font color="#0000ff">string </font>lastName, <font color="#0000ff">string </font>phoneNumber)      <br />&#160;&#160;&#160;&#160; {      <br /></font><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <b><font color="#006400">List&lt;</font><font color="#006400">Contact&gt; contacts = </font><font color="#006400">this.ContactManager.FindContacts(name, lastName, phoneNumber);</font>        <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#006400">View.DisplayContacts(contacts);</font></b>      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; return;      <br />&#160;&#160;&#160;&#160; }      <br /></font></p>  <p>3. Build the solution    <br />&#160;&#160;&#160;&#160; 4. Run the tests, now it should <b><font color="#9acd32">pass</font>.</b></p>  <h4>Step 3: Creating the test for no contacts found   <br /></h4>  <p>Now we&#8217;re going to create the test method that will check that a message is displayed when the number of contacts is less than 1.</p>  <ol>   <li>Open the <i>FindCustomerViewPresenterFixture.cs </i> </li>    <li>Add the following code (in the <i>FindCustomerViewPresenterFixture</i> class) </li> </ol>  <p><font face="Courier New"><font face="Courier New"><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; [<font color="#008080">TestMethod</font>]          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">public void</font> ContactsDisplayedWhenApply()          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; {          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; mockService.NumberOfResults = 0;          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; presenter.FindContacts(<font color="#0000ff">null</font>, <font color="#0000ff">null</font>, <font color="#0000ff">null</font>);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsTrue(mockService.DisplayMessageCalled);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsFalse(mockView.DisplayContactsCalled);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; }          <br /></font></font></font></p>  <p>3.&#160;&#160; Now run the test, it should fail.   <br />&#160;&#160;&#160; 4.&#160;&#160; Open the <i>FindContactViewPresenter.cs</i>    <br />&#160;&#160;&#160; 5.&#160;&#160; Add the following code to the <i>FindContacts </i>method</p>  <p><font face="Courier New">&#160;&#160;&#160; </font><font face="Courier New"><font color="#0000ff">public void </font>FindContacts(<font color="#0000ff">string </font>name, <font color="#0000ff">string </font>lastName, <font color="#0000ff">string </font>phoneNumber)      <br />&#160;&#160;&#160;&#160; {      <br /></font><font face="Courier New">&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#000000">List&lt;</font><font color="#000000">Contact&gt; contacts = </font><font color="#000000">this.ContactManager.FindContacts(name, lastName, phoneNumber);</font><b></b>      <p><font color="#0000ff">         <br /></font></p>   </font></p>  <p><font face="Courier New"><b><font color="#0000ff">&#160;&#160; <font color="#006400">&#160;&#160;&#160;&#160; if</font></font><font color="#006400">(contacts.Count &lt; 1)</font></b></font><font color="#006400">     <br /></font><font face="Courier New" color="#006400"><b>&#160;&#160;&#160;&#160;&#160;&#160;&#160; {</b></font><font color="#006400">     <br /></font><font face="Courier New" color="#006400"><b>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; View.DisplayMessage(&quot;No contacts found!&quot;);</b></font><font color="#006400">     <br /></font><font face="Courier New" color="#006400"><b>&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return;</b></font><font color="#006400">     <br /></font><font face="Courier New"><b><font color="#006400">&#160;&#160;&#160;&#160;&#160;&#160;&#160; }</font>        <br /></b></font>    <br /><font face="Courier New"><b><font color="#006400">&#160;&#160;&#160;&#160;&#160;&#160; </font></b><font color="#006400"> <font color="#000000">View.DisplayContacts(contacts);</font></font>      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">return</font>;      <br />&#160;&#160;&#160;&#160; }</font></p>  <p>6.&#160;&#160; Run the test, it will <font color="#ff0000"><font color="#000000">run </font><b><font color="#006400">successfully</font></b></font></p>  <h4><font color="#ff0000"><b><font color="#006400"><font color="#000000">Step 4:&#160; Creating the test when more than 10 contacts are found</font></font></b></font></h4>  <p>Now we&#8217;re going to create the test method that will check that a message is displayed when the number of contacts is less than 1.</p>  <p>1.&#160;&#160;&#160; Open the FindContactViewPresenter.cs   <br />2.&#160;&#160;&#160; Add the following code on the FindContactViewPresenterFixture class    <br />&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160;&#160;&#160;&#160; <font face="Courier New">[<font color="#008080">TestMethod</font>]      <br />&#160;&#160; <font color="#0000ff">public void</font> MessageIsDisplayedWhenMoreThan10ContactsAreFound()      <br />&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160; mockService.NumberOfResults = 11;      <br />&#160;&#160;&#160;&#160;&#160;&#160; presenter.FindContacts(<font color="#0000ff">null</font>, <font color="#0000ff">null</font>, <font color="#0000ff">null</font>);      <br />&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsTrue(mockView.ShowMessageCalled);      <br />&#160;&#160;&#160;&#160;&#160;&#160; <font color="#008080">Assert</font>.IsFalse(mockView.DisplayContactsCalled);      <br />&#160;&#160; }</font>    <p></p> 3.&#160;&#160;&#160; Build &amp; run the test, it should fail.    <br />4.&#160;&#160;&#160; Add the following code on the FindContactViewPresenter class (FindContactViewPresenter.cs)</p>  <p><font face="Courier New"><font color="#0000ff">public void </font>FindContacts(<font color="#0000ff">string </font>name, <font color="#0000ff">string </font>lastName, <font color="#0000ff">string </font>phoneNumber)      <br />&#160; {      <br />&#160;&#160;&#160; <font color="#008080">List</font>&lt;<font color="#008080">Contact</font>&gt; contacts = <font color="#0000ff">this</font>.ContactManager.FindContacts(name, lastName, phoneNumber);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; <br />&#160;&#160;&#160; <font color="#0000ff">if</font> (contacts.Count &lt; 1)      <br />&#160;&#160;&#160; {      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; View.ShowMessage(&quot;No contacts found&quot;);      <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160; <font color="#0000ff">return</font>;      <br />&#160;&#160;&#160; }      <br /><font color="#006400">&#160;<b>&#160; </b></font><b><font color="#006400"> else if (contacts.Count &gt; 10)         <br />&#160;&#160;&#160; {          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; View.ShowMessage(&quot;Too many contacts found, please narrow your search&quot;);          <br />&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160; return;          <br />&#160;&#160;&#160; }</font></b></font>    <p>View.DisplayContacts(contacts);     <br />&#160;&#160;&#160;&#160; <font color="#0000ff">return</font>;      <br />&#160; } </p> </p>  <p>5.&#160;&#160;&#160; Build &amp; run the test, it should pass</p>  <p>You can download the code from <a href="/blogs/johnny/yakarta.zip">here</a></p>  <h3>Conclusions</h3>  <p>We&#8217;ve fully implemented the requierement and the presenter has the expected behavior. We wrote consistent, robust and high quality code. The core idea of this is being consistent and develop using baby-steps to increase code quality.</p>  <p>Feedback is always welecome/expected</p>
